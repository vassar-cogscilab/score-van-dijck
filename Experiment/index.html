<!DOCTYPE html>
<html>
  <head>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="custom-plugins/jspsych-echo-response.js"></script>
    <script src="custom-plugins/jspsych-corsi.js"></script>
    <link rel="stylesheet" type="text/css" href="jspsych-6.1.0/css/jspsych.css">
    <style>
    p { font-size: 72px; }
    .instructions { width: 750px; }
    .instructions p { font-size: 18px; }
    </style>
  </head>
  <body>
  </body>
  <script>

  var wm_type = 'verbal'; // 'verbal' or 'spatial'
  var odd_left_first = jsPsych.randomization.sampleWithoutReplacement([true, false], 1)[0];

  var timeline = [];

  var baseline_intro_instructions = {
    type: 'html-keyboard-response',
    stimulus: '<div class="instructions"><p>In this part of the experiment, you\'ll see a single digit in the center of the screen.</p>'+
      '<p>Your task is to quickly determine whether the digit is ODD or EVEN.</p>'+
      '<p>Press A or L to continue.</p></div>',
    choices: ['a','l']
  }

  var baseline_task_odd_left_instructions = {
    timeline: [
      {
        type: 'html-keyboard-response',
        stimulus: '<div class="instructions">'+
          '<p>If the digit is ODD (1, 3, 7, or 9), press A on the keyboard.</p>'+
          '<p>If the digit is EVEN (2, 4, 6, or 8), press L on the keyboard.</p>'+
          '<p>Press A or L to continue.</p></div>',
        choices: ['a','l']
      },
      {
        type: 'html-keyboard-response',
        stimulus: '<div class="instructions"><p>If you answer incorrectly, the cross (+) in the center of the screen will turn red.</p>'+
          '<p>Press A or L to continue.</p></div>',
        choices: ['a','l']
      },
      {
        type: 'html-keyboard-response',
        stimulus: '<div class="instructions"><p>We will start with a few practice trials.</p>'+
          '<p>Press A or L to begin the practice.</p></div>',
        choices: ['a','l']
      }
    ]
  }

  var baseline_task_odd_right_instructions = {
    timeline: [
      {
        type: 'html-keyboard-response',
        stimulus: '<div class="instructions">'+
          '<p>If the digit is EVEN (2, 4, 6, or 8), press A on the keyboard.</p>'+
          '<p>If the digit is ODD (1, 3, 7, or 9), press L on the keyboard.</p>'+
          '<p>Press A or L to continue.</p></div>',
        choices: ['a','l']
      },
      {
        type: 'html-keyboard-response',
        stimulus: '<div class="instructions"><p>If you answer incorrectly, the cross (+) in the center of the screen will turn red.</p>'+
          '<p>Press A or L to continue.</p></div>',
        choices: ['a','l']
      },
      {
        type: 'html-keyboard-response',
        stimulus: '<div class="instructions"><p>We will start with a few practice trials.</p>'+
          '<p>Press A or L to begin the practice.</p></div>',
        choices: ['a','l']
      }
    ]
  }

  var baseline_practice_odd_left = {
    timeline: [
      {
        type: 'html-keyboard-response',
        stimulus: '<p>+</p>',
        trial_duration: 500,
        choices: jsPsych.NO_KEYS
      },
      {
        type: 'html-keyboard-response',
        stimulus: function(){ return "<p>"+jsPsych.timelineVariable('digit', true)+"</p>"},
        choices: ['a', 'l'],
        data: {
          correct_response: jsPsych.timelineVariable('target_response'),
          parity: jsPsych.timelineVariable('parity'),
          phase: 'baseline'
        },
        on_finish: function(data){
          data.correct = data.correct_response == jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press);
        }
      },
      {
        type: 'html-keyboard-response',
        stimulus: function(){
          if(jsPsych.data.get().last(1).values()[0].correct){
            return '<p>+</p>';
          } else {
            return '<p style="color: red;">+</p>';
          }
        },
        trial_duration: 250,
        choices: jsPsych.NO_KEYS,
        post_trial_gap: 250
      },
      {
        timeline: [
          {
            type: 'html-keyboard-response',
            stimulus: '<div class="instructions"><p>Press A if the digit is ODD.</p><p>Press L if the digit is EVEN.</p></div>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 3000,
            post_trial_gap: 1000
          }
        ],
        conditional_function: function(){
          var was_correct = jsPsych.data.get().last(2).values()[0].correct;
          return !was_correct;
        }
      }
    ],
    timeline_variables: [
      {digit: 1, parity: 'odd', target_response: 'a'},
      {digit: 2, parity: 'even', target_response: 'l'},
      {digit: 3, parity: 'odd', target_response: 'a'},
      {digit: 4, parity: 'even', target_response: 'l'},
      {digit: 6, parity: 'even', target_response: 'l'},
      {digit: 7, parity: 'odd', target_response: 'a'},
      {digit: 8, parity: 'even', target_response: 'l'},
      {digit: 9, parity: 'odd', target_response: 'a'},
    ],
    randomize_order: true
  }

  var baseline_practice_odd_right = {
    timeline: [
      {
        type: 'html-keyboard-response',
        stimulus: '<p>+</p>',
        trial_duration: 500,
        choices: jsPsych.NO_KEYS
      },
      {
        type: 'html-keyboard-response',
        stimulus: function(){ return "<p>"+jsPsych.timelineVariable('digit', true)+"</p>"},
        choices: ['a', 'l'],
        data: {
          correct_response: jsPsych.timelineVariable('target_response'),
          parity: jsPsych.timelineVariable('parity'),
          phase: 'baseline'
        },
        on_finish: function(data){
          data.correct = data.correct_response == jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press);
        }
      },
      {
        type: 'html-keyboard-response',
        stimulus: function(){
          if(jsPsych.data.get().last(1).values()[0].correct){
            return '<p>+</p>';
          } else {
            return '<p style="color: red;">+</p>';
          }
        },
        trial_duration: 250,
        choices: jsPsych.NO_KEYS,
        post_trial_gap: 250
      },
      {
        timeline: [
          {
            type: 'html-keyboard-response',
            stimulus: '<div class="instructions"><p>Press A if the digit is EVEN.</p><p>Press L if the digit is ODD.</p></div>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 3000,
            post_trial_gap: 1000
          }
        ],
        conditional_function: function(){
          var was_correct = jsPsych.data.get().last(2).values()[0].correct;
          return !was_correct;
        }
      }
    ],
    timeline_variables: [
      {digit: 1, parity: 'odd', target_response: 'l'},
      {digit: 2, parity: 'even', target_response: 'a'},
      {digit: 3, parity: 'odd', target_response: 'l'},
      {digit: 4, parity: 'even', target_response: 'a'},
      {digit: 6, parity: 'even', target_response: 'a'},
      {digit: 7, parity: 'odd', target_response: 'l'},
      {digit: 8, parity: 'even', target_response: 'a'},
      {digit: 9, parity: 'odd', target_response: 'l'},
    ],
    randomize_order: true
  }

  var baseline_continue = {
    type: 'html-keyboard-response',
    stimulus: '<div class="instructions"><p>That concludes the practice.</p>'+
      '<p>There are XXXX trials in this part of the experiment.</p>'+
      '<p>When you are ready to begin, press A or L.</p>',
    choices: ['a','l']
  }

  var baseline_task_odd_left = {
    timeline: [
      {
        type: 'html-keyboard-response',
        stimulus: '<p>+</p>',
        trial_duration: 500,
        choices: jsPsych.NO_KEYS
      },
      {
        type: 'html-keyboard-response',
        stimulus: function(){ return "<p>"+jsPsych.timelineVariable('digit', true)+"</p>"},
        choices: ['a', 'l'],
        data: {
          correct_response: jsPsych.timelineVariable('target_response'),
          parity: jsPsych.timelineVariable('parity'),
          phase: 'baseline'
        },
        on_finish: function(data){
          data.correct = data.correct_response == jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press);
        }
      },
      {
        type: 'html-keyboard-response',
        stimulus: function(){
          if(jsPsych.data.get().last(1).values()[0].correct){
            return '<p>+</p>';
          } else {
            return '<p style="color: red;">+</p>';
          }
        },
        trial_duration: 250,
        choices: jsPsych.NO_KEYS,
        post_trial_gap: 250
      }
    ],
    timeline_variables: [
      {digit: 1, parity: 'odd', target_response: 'a'},
      {digit: 2, parity: 'even', target_response: 'l'},
      {digit: 3, parity: 'odd', target_response: 'a'},
      {digit: 4, parity: 'even', target_response: 'l'},
      {digit: 6, parity: 'even', target_response: 'l'},
      {digit: 7, parity: 'odd', target_response: 'a'},
      {digit: 8, parity: 'even', target_response: 'l'},
      {digit: 9, parity: 'odd', target_response: 'a'},
    ],
    randomize_order: true,
    repetitions: 2
  }

  var baseline_task_odd_right = {
    timeline: [
      {
        type: 'html-keyboard-response',
        stimulus: '<p>+</p>',
        trial_duration: 500,
        choices: jsPsych.NO_KEYS
      },
      {
        type: 'html-keyboard-response',
        stimulus: function(){ return "<p>"+jsPsych.timelineVariable('digit', true)+"</p>"},
        choices: ['a', 'l'],
        data: {
          correct_response: jsPsych.timelineVariable('target_response'),
          parity: jsPsych.timelineVariable('parity'),
          phase: 'baseline'
        },
        on_finish: function(data){
          data.correct = data.correct_response == jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press);
        }
      },
      {
        type: 'html-keyboard-response',
        stimulus: function(){
          if(jsPsych.data.get().last(1).values()[0].correct){
            return '<p>+</p>';
          } else {
            return '<p style="color: red;">+</p>';
          }
        },
        trial_duration: 250,
        choices: jsPsych.NO_KEYS,
        post_trial_gap: 250
      }
    ],
    timeline_variables: [
      {digit: 1, parity: 'odd', target_response: 'l'},
      {digit: 2, parity: 'even', target_response: 'a'},
      {digit: 3, parity: 'odd', target_response: 'l'},
      {digit: 4, parity: 'even', target_response: 'a'},
      {digit: 6, parity: 'even', target_response: 'a'},
      {digit: 7, parity: 'odd', target_response: 'l'},
      {digit: 8, parity: 'even', target_response: 'a'},
      {digit: 9, parity: 'odd', target_response: 'l'},
    ],
    randomize_order: true,
    repetitions: 2
  }

  var baseline_switch_instructions = {
    type: 'html-keyboard-response',
    stimulus: '<div class="instructions"><p>In this next part, you\'ll do the same task but the keys are swapped.</p>'+
      '<p>Press A or L to continue.</p>',
    choices: ['a','l']
  }

  /* add baseline to timeline */
 /* timeline.push(baseline_intro_instructions);
  if(odd_left_first){
    timeline.push(baseline_task_odd_left_instructions);
    timeline.push(baseline_practice_odd_left);
    timeline.push(baseline_continue);
    timeline.push(baseline_task_odd_left);
  } else {
    timeline.push(baseline_task_odd_right_instructions);
    timeline.push(baseline_practice_odd_right);
    timeline.push(baseline_continue);
    timeline.push(baseline_task_odd_right);
  }
  timeline.push(baseline_switch_instructions);
  if(!odd_left_first){
    timeline.push(baseline_task_odd_left_instructions);
    timeline.push(baseline_practice_odd_left);
    timeline.push(baseline_continue);
    timeline.push(baseline_task_odd_left);
  } else {
    timeline.push(baseline_task_odd_right_instructions);
    timeline.push(baseline_practice_odd_right);
    timeline.push(baseline_continue);
    timeline.push(baseline_task_odd_right);
  }*/

  /* define WM tasks */

  var baseline_end = {
    type: 'html-keyboard-response',
    stimulus: '<div class="instructions"><p>You have completed part 1 of the experiment!</p>'+
      '<p'
  }

  var seq_loc = 0;
  var wm_span_verbal = {
    timeline: [
      {
        type: 'html-keyboard-response',
        stimulus: '',
        choices: jsPsych.NO_KEYS,
        trial_duration: 1500,
      },
      {
        timeline: [
          {
            type: 'html-keyboard-response',
            stimulus: function(){
              return '<p>'+jsPsych.timelineVariable('sequence',true)[seq_loc]+'</p>'
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: 1250,
            post_trial_gap: 250
          }
        ],
        loop_function: function(){
          seq_loc++;
          if(seq_loc == jsPsych.timelineVariable('sequence', true).length){
            return false;
          } else {
            return true;
          }
        }
      },
      {
        type: 'html-keyboard-response',
        stimulus: '',
        choices: jsPsych.NO_KEYS,
        trial_duration: 1250,
        on_finish: function(){
          seq_loc = 0;
        }
      },
      {
        type: 'echo-response',
        prompt: '<div class="instructions"><p>Type the sequence of letters in the same order you saw them</p></div>',
        sequence: jsPsych.timelineVariable('sequence'),
        echo_font_size: 48,
        data: {
          phase: 'wm-span',
          length: jsPsych.timelineVariable('sequence_length')
        }
      }
    ],
    timeline_variables: [
      {sequence_length: 3, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 3)},
      {sequence_length: 3, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 3)},
      {sequence_length: 3, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 3)},

      {sequence_length: 4, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 4)},
      {sequence_length: 4, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 4)},
      {sequence_length: 4, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 4)},

      {sequence_length: 5, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 5)},
      {sequence_length: 5, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 5)},
      {sequence_length: 5, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 5)},

      {sequence_length: 6, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 6)},
      {sequence_length: 6, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 6)},
      {sequence_length: 6, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 6)},

      {sequence_length: 7, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 7)},
      {sequence_length: 7, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 7)},
      {sequence_length: 7, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 7)},

      {sequence_length: 8, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 8)},
      {sequence_length: 8, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 8)},
      {sequence_length: 8, sequence: jsPsych.randomization.sampleWithoutReplacement(['q','w','r','t','p','s','d','f','g','h','j','k','l','z','x','c','v','b','n','m'], 8)}
    ]
  }

  var wm_span_spatial = {
    timeline: [
      {
        type: 'corsi',
        mode: 'display',
        sequence: jsPsych.timelineVariable('sequence'),
        blocks: [
          {y: 25, x: 25},
          {y: 30, x: 50},
          {y: 80, x: 85},
          {y: 40, x: 70},
          {y: 55, x: 65},
          {y: 70, x: 45},
          {y: 10, x: 30},
          {y: 65, x: 15},
          {y: 85, x: 20}
        ],
        block_size: 50,
        arena_width: 750,
        arena_height: 500,
        sequence_duration: 1000,
        sequence_iti: 500,
        pre_stim_duration: 1500,
        post_trial_gap:1500
      },

      {
        type: 'corsi',
        mode: 'input',
        sequence: jsPsych.timelineVariable('sequence'),
        blocks: [
          {y: 25, x: 25},
          {y: 30, x: 50},
          {y: 80, x: 85},
          {y: 40, x: 70},
          {y: 55, x: 65},
          {y: 70, x: 45},
          {y: 10, x: 30},
          {y: 65, x: 15},
          {y: 85, x: 20}
        ],
        block_size: 50,
        arena_width: 750,
        arena_height: 500,
        post_trial_gap:1500,
        data: {
          phase: 'wm-span',
          length: jsPsych.timelineVariable('sequence_length')
        }
      }
    ],
    timeline_variables: [
      {sequence_length: 3, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 3)},
      {sequence_length: 3, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 3)},
      {sequence_length: 3, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 3)},

      {sequence_length: 4, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 4)},
      {sequence_length: 4, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 4)},
      {sequence_length: 4, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 4)},

      {sequence_length: 5, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 5)},
      {sequence_length: 5, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 5)},
      {sequence_length: 5, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 5)},

      {sequence_length: 6, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 6)},
      {sequence_length: 6, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 6)},
      {sequence_length: 6, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 6)},

      {sequence_length: 7, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 7)},
      {sequence_length: 7, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 7)},
      {sequence_length: 7, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 7)},

      {sequence_length: 8, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 8)},
      {sequence_length: 8, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 8)},
      {sequence_length: 8, sequence: jsPsych.randomization.sampleWithoutReplacement([0,1,2,3,4,5,6,7,8], 8)}
    ]
  }

  var span_calculation = {
    type: 'call-function',
    data: {
      phase: 'calculate-span'
    },
    func: function(){
      var span = 2;
      for(var wmspan = 8; wmspan >= 3; wmspan--){
        var total_correct = jsPsych.data.get().filter({phase: 'wm-span', length: wmspan, correct: true}).count();
        if(total_correct >= 2){
          span = wmspan;
          break;
        }
      }
      return span;
    }
  }

  var load_verbal = {

  }

  var load_spatial = {
    timeline: [
      {
        type: 'corsi',
        mode: 'display',
        sequence: jsPsych.timelineVariable('sequence'),
        blocks: [
          {y: 25, x: 25},
          {y: 30, x: 50},
          {y: 80, x: 85},
          {y: 40, x: 70},
          {y: 55, x: 65},
          {y: 70, x: 45},
          {y: 10, x: 30},
          {y: 65, x: 15},
          {y: 85, x: 20}
        ],
        block_size: 50,
        arena_width: 750,
        arena_height: 500,
        sequence_duration: 1000,
        sequence_iti: 500,
        pre_stim_duration: 1500
      },
      {
        timeline: [

        ],
        timeline_variables: [

        ]
      },
      {
        type: 'corsi',
        mode: 'input',
        sequence: jsPsych.timelineVariable('sequence'),
        blocks: [
          {y: 25, x: 25},
          {y: 30, x: 50},
          {y: 80, x: 85},
          {y: 40, x: 70},
          {y: 55, x: 65},
          {y: 70, x: 45},
          {y: 10, x: 30},
          {y: 65, x: 15},
          {y: 85, x: 20}
        ],
        block_size: 50,
        arena_width: 750,
        arena_height: 500,
        post_trial_gap:1500
      }
    ],
    timeline_variables: [
      {sequence: [0,1,2]},
      {sequence: [5,4,3]}
    ]
  }

  timeline.push(wm_span_spatial);
  timeline.push(span_calculation);

  jsPsych.init({
    timeline: timeline
  })


  </script>
</html>